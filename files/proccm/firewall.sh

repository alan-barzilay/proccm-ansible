
firewall.sh
---------------------------------------------------------
#!/bin/bash

# Vairáveis que recebem o nome das interfaces interna, externa
# e o ip público da proccm
INTERNA=""
EXTERNA=""
IPPUBLICO=""
SSHD=""

######################################################
# FLUSH ALL RULES IN THE MANGLE, NAT AND FILTER TABLES
######################################################
iptables -t mangle -F
iptables -t nat -F
iptables -t filter -F

#############################################################
# DELETE ALL USER-DEFINED (NOT BUILT-IN) CHAINS IN THE TABLES
#############################################################
iptables -t mangle -X
iptables -t nat -X
iptables -t filter -X

##################################################
# SET ALL POLICIES FOR ALL BUILT-IN CHAINS TO DROP
##################################################
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

##############################################################################
# (1) TRAFFIC INITIATED BY THE FIREWALL AND DESTINED FOR THE INTERNET (OUTPUT)
# Vazio pq confiamos nos usuários do proccm
##############################################################################


###############################################################################
# (2) TRAFFIC INITIATED FROM THE INTERNET AND DESTINED FOR THE FIREWALL (INPUT)
# Novas conexões apenas para ssh e ping (established e related ao final do script)
###############################################################################

iptables -t filter -A INPUT -i $EXTERNA -p tcp --destination-port $SSHD -m state --state NEW -j ACCEPT

iptables -t filter -A INPUT -i $EXTERNA -p icmp --icmp-type echo-request -m state --state NEW -j ACCEPT

######################################################################################
# (3) TRAFFIC INITIATED BY THE FIREWALL AND DESTINED FOR THE INTERNAL NETWORK (OUTPUT)
# Vazio pq confiamos nos usuários do proccm
######################################################################################


#####################################################################################
# (4) TRAFFIC INITIATED BY THE INTERNAL NETWORK AND DESTINED FOR THE FIREWALL (INPUT)
# Aceitar qualquer nova conexão pq confiamos nos usuários da sala de computação
#####################################################################################

iptables -t filter -A INPUT -i $INTERNA -m state --state NEW -j ACCEPT

######################################################################################
# (5) TRAFFIC INITIATED BY THE INTERNAL NETWORK AND DESTINED FOR THE OUTSIDE (FORWARD)
# Aceitar novas conexões, pq confiamos nos usuários da sala de computação, e fazer nat
######################################################################################

iptables -t filter -A FORWARD -i $INTERNA -m state --state NEW -j ACCEPT

iptables -t nat -A POSTROUTING -o $EXTERNA -j SNAT --to-source $IPPUBLICO

################################################################################
# (6) TRAFFIC INITIATED FROM THE INTERNET AND DESTINED FOR THE INTERNAL NETWORK (FORWARD)
# Vazio para dropar tudo que é new (established e related ao final do script)
################################################################################


#############################################
# Aceitar tudo o que é estabilished e related
#############################################

iptables -t filter -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t filter -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t filter -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t filter -A INPUT -m state --state NEW -i lo -j ACCEPT
---------------------------------------------------------

